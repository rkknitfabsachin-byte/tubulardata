<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RK KNIT FAB â€” Tubular Entry</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body.dark{
      background:
        radial-gradient(1200px 600px at 10% -10%, #7dd3fc44, transparent),
        radial-gradient(1000px 600px at 110% 10%, #c084fc33, transparent),
        linear-gradient(180deg,#0b1220,#0b1220 40%,#0e1426 100%);
      color:#e2e8f0;
    }
    body.light{ background:#f7fbff; color:#0f172a; }
    .glass.dark{ backdrop-filter: blur(12px); background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14); }
    .glass.light{ background:#ffffffee; backdrop-filter: blur(10px); border:1px solid #e2e8f0; box-shadow:0 10px 25px rgba(2,132,199,.06); }
    @keyframes fadeSlide{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }
    .fade-in{ animation: fadeSlide .45s ease both; }
    .ctrl{ height:44px }
  </style>
</head>
<body class="dark min-h-screen transition-colors duration-300">
<header class="max-w-6xl mx-auto px-4 pt-6 pb-4">
  <div class="flex items-center justify-between gap-3">
    <h1 class="text-xl sm:text-2xl font-bold tracking-tight">ðŸ§µ RK KNIT FAB â€” <span class="text-sky-300">Tubular Entry</span></h1>
    <div class="flex items-center gap-2">
      <a href="./records.html" class="px-3 py-2 rounded-xl glass dark text-sm">ðŸ“œ View Records</a>
      <button id="themeToggle" class="px-3 py-2 rounded-xl glass dark text-sm">ðŸŒ™ Dark</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 pb-24">

  <!-- DASHBOARD -->
  <section class="glass dark rounded-3xl p-4 sm:p-6 fade-in">
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
      <div class="p-3 rounded-2xl glass dark">
        <div class="text-xs opacity-70">Total Records</div>
        <div id="statTotal" class="text-xl font-semibold">â€”</div>
      </div>
      <div class="p-3 rounded-2xl glass dark">
        <div class="text-xs opacity-70">Today</div>
        <div id="statToday" class="text-xl font-semibold">â€”</div>
      </div>
      <div class="p-3 rounded-2xl glass dark">
        <div class="text-xs opacity-70">Total Qty</div>
        <div id="statQty" class="text-xl font-semibold">â€”</div>
      </div>
      <div class="p-3 rounded-2xl glass dark">
        <div class="text-xs opacity-70">Last Sync</div>
        <div id="statSync" class="text-xl font-semibold">â€”</div>
      </div>
    </div>
  </section>

  <!-- ADD ENTRY -->
  <section class="glass dark rounded-3xl p-5 sm:p-6 mt-4 fade-in">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">âž• Add Entry</h2>
      <div class="text-xs opacity-70">Single-page â€¢ Mobile-first</div>
    </div>

    <div class="grid sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-xs mb-1 opacity-80">Date</label>
        <input id="fDate" type="date" class="ctrl w-full glass dark rounded-2xl px-3"/>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Name</label>
        <select id="fUser" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Lot No</label>
        <input id="fLot" class="ctrl w-full glass dark rounded-2xl px-3" placeholder="Enter lot number"/>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Item</label>
        <input id="fItemSearch" class="ctrl w-full glass dark rounded-2xl px-3 mb-2" placeholder="Search itemâ€¦"/>
        <select id="fItem" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Colour</label>
        <input id="fColourSearch" class="ctrl w-full glass dark rounded-2xl px-3 mb-2" placeholder="Search colourâ€¦"/>
        <select id="fColour" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Item Qty (rolls)</label>
        <input id="fQty" type="number" class="ctrl w-full glass dark rounded-2xl px-3" placeholder="0"/>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Bag Size</label>
        <select id="fBag" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Bag Wt in KG</label>
        <input id="fBagKg" type="number" class="ctrl w-full glass dark rounded-2xl px-3" placeholder="Auto" readonly/>
      </div>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="btnSubmit" class="flex-1 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold py-3">âœ… Submit</button>
      <button id="btnClear" class="flex-1 rounded-2xl glass dark font-semibold py-3">Clear</button>
    </div>

    <div id="toast" class="hidden mt-3 px-4 py-3 rounded-xl text-sm font-semibold glass dark">Saved!</div>
  </section>
</main>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbyluofZ3brYfUdQCaAPgm5-gJJZqUsknmi9aBH0fFM0Elpw-yXsWS1UHcOdmUlB50wO/exec';

/* ===== THEME ===== */
const body=document.body, btnTheme=document.getElementById('themeToggle');
function applyTheme(t){
  body.classList.remove('dark','light'); body.classList.add(t);
  document.querySelectorAll('.glass').forEach(el=>{ el.classList.remove('dark','light'); el.classList.add(t); });
  btnTheme.textContent = t==='dark' ? 'ðŸŒ™ Dark' : 'â˜€ï¸ Light';
  localStorage.setItem('theme',t);
}
applyTheme(localStorage.getItem('theme') || 'dark');
btnTheme.addEventListener('click', ()=> applyTheme(body.classList.contains('dark') ? 'light' : 'dark'));

/* ===== STATE ===== */
let masters={ items:[], colours:[], users:[] };
let bagPairs=[];           // [{size, weight(g), sku}]
let itemToSku={};          // ITEM -> SKU CODE
let itemBagMap={};         // ITEM -> default bag size
let sizeToSku={};          // BAG SIZE -> BAG SKU
let metaHeaders=[], H={};

/* ===== UTIL ===== */
const byId=id=>document.getElementById(id);
const toast=(msg,ok=true)=>{ const t=byId('toast'); t.textContent=msg; t.classList.remove('hidden'); t.style.background= ok?'#22c55e22':'#ef444422'; setTimeout(()=>t.classList.add('hidden'),1600); };
const todayYMD=()=> new Date().toISOString().slice(0,10);
const debounce=(fn,d)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d);} };

/* ===== HEADER MAP (data sheet) ===== */
function buildHeaderMap(headers){
  const arr=headers.map(h=>String(h||'').trim());
  const find=(...p)=> arr.find(h=> p.some(x=> h.toLowerCase().includes(x))) || null;
  return {
    DATE:      find('date'),
    NAME:      find('name','user'),
    LOT:       find('lot'),
    SKU:       find('sku code'),     // item sku
    ITEM:      find('item'),
    COLOUR:    find('colour','color'),
    QTY:       find('item qty','qty','quantity'),
    BAGSIZE:   find('bag size'),
    BAGKG:     find('bag wt in kg','bag kg'),
    BAGSKU:    find('sku code') && headers.lastIndexOf(find('sku code')) !== headers.indexOf(find('sku code')) ? headers[headers.lastIndexOf(find('sku code'))] : 'sku code' // fallback
  };
}

/* ===== LOAD MASTERS ===== */
async function loadMasters(){
  const u=new URL(API); u.searchParams.set('action','masters');
  const r=await fetch(u); const j=await r.json();
  masters.items = (j.masters?.items||[]); 
  masters.colours = (j.masters?.colours||[]);
  masters.users = (j.masters?.users||[]);
  bagPairs = j.bagPairs || [];
  itemToSku = j.itemToSku || {};
  itemBagMap = j.bagMap || {};
  sizeToSku = j.sizeToSku || {};

  fillSel('fUser', masters.users);
  fillSel('fItem', masters.items);
  fillSel('fColour', masters.colours);
  fillSelPairs('fBag', bagPairs);
}

/* ===== LOAD META + for dashboard quick stats ===== */
async function loadMeta(){
  const u=new URL(API); u.searchParams.set('action','meta');
  const r=await fetch(u); const j=await r.json();
  metaHeaders = j.headers || []; H = buildHeaderMap(metaHeaders);
}

/* ===== DASHBOARD COUNTS ===== */
async function loadCounts(){
  const u=new URL(API); u.searchParams.set('action','list');
  const r=await fetch(u); const j=await r.json();
  const recs=j.records||[];
  byId('statTotal').textContent = recs.length;
  const t=todayYMD();
  const dateKey=H.DATE;
  byId('statToday').textContent = dateKey ? recs.filter(x=>{
    const d=x[dateKey]; if(!d) return false;
    const iso=(new Date(d)).toISOString().slice(0,10);
    return iso===t;
  }).length : 'â€”';
  let sum=0; if (H.QTY) recs.forEach(x=> sum+= Number(x[H.QTY]||0));
  byId('statQty').textContent = sum;
  byId('statSync').textContent = new Date().toLocaleTimeString();
}

/* ===== UI helpers ===== */
function fillSel(id, arr){ const el=byId(id); el.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); }); }
function fillSelPairs(id, arr){ const el=byId(id); el.innerHTML=''; arr.forEach(p=>{ const o=document.createElement('option'); o.value=p.size; o.textContent=p.size; o.dataset.weight=p.weight; o.dataset.sku=p.sku||''; el.appendChild(o); }); }

/* ===== FORM LOGIC ===== */
function calcBagKg(){
  const qty=Number(byId('fQty').value||0);
  const w=Number((byId('fBag').selectedOptions[0]?.dataset.weight)||0); // grams
  byId('fBagKg').value = ((qty*w)/1000).toFixed(2);
}
byId('fQty').addEventListener('input', calcBagKg);
byId('fBag').addEventListener('change', calcBagKg);

/* Searchable selects */
function filterSel(selectId, src, q){ const el=byId(selectId); const list=src.filter(x=>String(x).toLowerCase().includes((q||'').toLowerCase())); el.innerHTML=''; list.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); }); }
byId('fItemSearch').addEventListener('input', e=> filterSel('fItem', masters.items, e.target.value));
byId('fColourSearch').addEventListener('input', e=> filterSel('fColour', masters.colours, e.target.value));

/* Item change â†’ auto default bag + auto item SKU (for saving) */
byId('fItem').addEventListener('change', ()=>{
  const it=byId('fItem').value;
  const def=itemBagMap[it];
  if (def){
    const opt = Array.from(byId('fBag').options).find(o=> String(o.value)===String(def));
    if (opt) byId('fBag').value = opt.value;
  }
  calcBagKg();
});

/* Submit */
byId('btnSubmit').addEventListener('click', async ()=>{
  if (!H.DATE || !H.NAME || !H.LOT || !H.ITEM || !H.COLOUR || !H.QTY || !H.BAGSIZE || !H.BAGKG || !H.SKU || !H.BAGSKU){
    toast('Sheet headers not detected properly', false); return;
  }
  // build record keyed by EXACT sheet headers
  const item = byId('fItem').value;
  const bagSize = byId('fBag').value;

  const rec = {};
  rec[H.DATE]    = byId('fDate').value ? new Date(byId('fDate').value) : new Date();
  rec[H.NAME]    = byId('fUser').value;
  rec[H.LOT]     = byId('fLot').value;
  rec[H.SKU]     = itemToSku[item] || '';           // item SKU
  rec[H.ITEM]    = item;
  rec[H.COLOUR]  = byId('fColour').value;
  rec[H.QTY]     = Number(byId('fQty').value||0);
  rec[H.BAGSIZE] = bagSize;
  rec[H.BAGKG]   = Number(byId('fBagKg').value||0);
  // bag SKU from size (fallback from select data-sku)
  rec[H.BAGSKU]  = sizeToSku[bagSize] || (byId('fBag').selectedOptions[0]?.dataset.sku) || '';

  const res = await fetch(API,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'create', record: rec }) });
  const j = await res.json();
  if (j.error){ toast('Save failed', false); return; }
  toast('Saved');
  byId('fLot').value=''; byId('fQty').value=''; byId('fBagKg').value='';
  await loadCounts();
});

/* Clear */
byId('btnClear').addEventListener('click', ()=>{
  ['fDate','fLot','fQty','fBagKg'].forEach(id=> byId(id).value='');
});

/* INIT */
(async function init(){
  byId('fDate').value = todayYMD();
  await loadMeta();
  await loadMasters();
  await loadCounts();
})();
</script>
</body>
</html>
