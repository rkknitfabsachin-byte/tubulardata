<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RK KNIT FAB ‚Äî Records</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body.dark{
      background:
        radial-gradient(1200px 600px at 10% -10%, #7dd3fc44, transparent),
        radial-gradient(1000px 600px at 110% 10%, #c084fc33, transparent),
        linear-gradient(180deg,#0b1220,#0b1220 40%,#0e1426 100%);
      color:#e2e8f0;
    }
    body.light{ background:#f7fbff; color:#0f172a; }
    .glass.dark{ backdrop-filter: blur(12px); background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14); }
    .glass.light{ background:#ffffffee; backdrop-filter: blur(10px); border:1px solid #e2e8f0; box-shadow:0 10px 25px rgba(2,132,199,.06); }

    @keyframes spin{ to{ transform:rotate(360deg);} }
    @keyframes fadeSlide{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }
    .ico-gear{ animation: spin 1.2s linear infinite; }
    .fade-in{ animation: fadeSlide .45s ease both; }

    .ctrl{ height:44px }
    .sheet{ position:fixed; left:0; right:0; bottom:-100%; background:rgba(255,255,255,0.92); backdrop-filter: blur(14px); border-top-left-radius:22px; border-top-right-radius:22px; box-shadow:0 -10px 30px rgba(0,0,0,.25); transition:bottom .35s ease; }
    body.dark .sheet{ background:rgba(17,24,39,.92); }
    .sheet.open{ bottom:0; }
  </style>
</head>
<body class="dark min-h-screen transition-colors duration-300">

<header class="max-w-6xl mx-auto px-4 pt-6 pb-4">
  <div class="flex items-center justify-between gap-3">
    <h1 class="text-xl sm:text-2xl font-bold tracking-tight">üßµ RK KNIT FAB ‚Äî <span class="text-sky-300">Records</span></h1>
    <div class="flex items-center gap-2">
      <a href="./index.html" class="px-3 py-2 rounded-xl glass dark hover:bg-white/10 light:hover:bg-slate-200 text-sm">‚Üê Back to Entry</a>
      <button id="themeToggle" class="px-3 py-2 rounded-xl glass dark hover:bg-white/10 light:hover:bg-slate-200 text-sm">üåô Dark</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 pb-24">
  <!-- FILTERS -->
  <section class="glass dark rounded-3xl p-5 sm:p-6 fade-in">
    <div class="grid sm:grid-cols-6 gap-3 items-end">
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">User</label>
        <select id="fUser" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">From</label>
        <input type="date" id="fFrom" class="ctrl w-full glass dark rounded-2xl px-3"/>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">To</label>
        <input type="date" id="fTo" class="ctrl w-full glass dark rounded-2xl px-3"/>
      </div>
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">Search</label>
        <input id="q" class="ctrl w-full glass dark rounded-2xl px-3" placeholder="Item / Colour / Lot"/>
      </div>
      <div>
        <button id="btnClear" class="ctrl w-full rounded-2xl glass dark font-semibold">Clear</button>
      </div>
    </div>
  </section>

  <!-- LIST -->
  <section class="glass dark rounded-3xl p-5 sm:p-6 mt-4 fade-in">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Results</h2>
      <button id="btnRefresh" class="ctrl px-3 rounded-2xl glass dark font-semibold">Refresh</button>
    </div>
    <div id="records" class="grid gap-2"></div>
    <div id="loader" class="hidden mt-3 flex items-center gap-2 opacity-80">
      <svg class="ico-gear" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Z" stroke="currentColor" stroke-width="1.8"/><path d="M4 12h2M18 12h2M12 4v2M12 18v2M17 7l-1.4 1.4M8.4 16.6 7 18M7 7l1.4 1.4M16.6 16.6 18 18" stroke="currentColor" stroke-width="1.8"/></svg>
      <span>Loading‚Ä¶</span>
    </div>
  </section>
</main>

<!-- EDIT SHEET -->
<div id="editSheet" class="sheet p-4">
  <div class="max-w-3xl mx-auto">
    <div class="flex items-center justify-between mb-2">
      <div class="text-lg font-semibold">‚úèÔ∏è Edit Record</div>
      <button id="btnCloseSheet" class="px-3 py-1 rounded-lg glass dark">Close</button>
    </div>
    <div class="grid sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-xs mb-1 opacity-80">User</label>
        <select id="eUser" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Lot No</label>
        <input id="eLot" class="ctrl w-full glass dark rounded-2xl px-3"/>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Item</label>
        <input id="eItemSearch" class="ctrl w-full glass dark rounded-2xl px-3 mb-2" placeholder="Search item‚Ä¶"/>
        <select id="eItem" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Colour</label>
        <input id="eColourSearch" class="ctrl w-full glass dark rounded-2xl px-3 mb-2" placeholder="Search colour‚Ä¶"/>
        <select id="eColour" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Quantity (rolls)</label>
        <input id="eQty" type="number" class="ctrl w-full glass dark rounded-2xl px-3"/>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Plastic Bag Size</label>
        <select id="eBag" class="ctrl w-full glass dark rounded-2xl px-3"></select>
      </div>
      <div>
        <label class="block text-xs mb-1 opacity-80">Plastic Bag Qty (kg)</label>
        <input id="eBagKg" type="number" class="ctrl w-full glass dark rounded-2xl px-3" readonly/>
      </div>
    </div>
    <div class="mt-3 flex gap-2">
      <button id="btnSaveEdit" class="flex-1 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold py-3">Save</button>
      <button id="btnDelete" class="flex-1 rounded-2xl bg-rose-500 hover:bg-rose-400 text-white font-semibold py-3">Delete</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbzpNNZbdznf953yIf9j4D5UhLhCfXVgVVjcupqEeQDZ5LIq_OKcKPdqEt9xz63gO9GN/exec'; // /exec URL

/* ===== THEME ===== */
const body=document.body, btnTheme=document.getElementById('themeToggle');
function applyTheme(t){
  body.classList.remove('dark','light'); body.classList.add(t);
  document.querySelectorAll('.glass').forEach(el=>{ el.classList.remove('dark','light'); el.classList.add(t); });
  btnTheme.textContent = t==='dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
  localStorage.setItem('theme',t);
}
applyTheme(localStorage.getItem('theme') || 'dark');
btnTheme.addEventListener('click', ()=> applyTheme(body.classList.contains('dark') ? 'light' : 'dark'));

/* ===== STATE ===== */
let metaHeaders=[], headerMap={};
let masters={ users:[], items:[], colours:[], bagPairs:[] };
let records=[], filtered=[];
let editing={ id:null, record:{} };

/* ===== UTIL ===== */
const byId=id=>document.getElementById(id);
const toast=(msg,ok=true)=>{ const t=document.createElement('div'); t.className='fixed left-1/2 -translate-x-1/2 bottom-6 px-4 py-3 rounded-xl text-sm font-semibold glass dark '+(ok?'':'bg-rose-500/20'); t.textContent=msg; document.body.appendChild(t); setTimeout(()=> t.remove(), 1600); };
const debounce=(fn,d)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d);} };
const fmtDate=v=>{ const d=new Date(v); return isNaN(d)?'':d.toLocaleDateString(); };

/* ===== HEADER MAP ===== */
function buildHeaderMap(headers){
  const H=headers.map(h=>String(h||'').trim());
  const find=(...parts)=> H.find(h=> parts.some(p=> h.toLowerCase().includes(p))) || null;
  return {
    USER:find('user'), LOT:find('lot'),
    ITEM:find('item'), COLOUR:find('colour','color'),
    QTY:find('qty','quantity'),
    BAGSIZE:find('bag size','plastic bag size','bag_size'),
    BAGKG:find('bag qty','bag kg','plastic bag qty','bag weight'),
    TIMESTAMP:find('timestamp','time','date')
  };
}

/* ===== LOAD ===== */
async function loadMeta(){ const u=new URL(API); u.searchParams.set('action','meta'); const r=await fetch(u); const j=await r.json(); metaHeaders=j.headers||[]; headerMap=buildHeaderMap(metaHeaders); }
async function loadMasters(){
  const u=new URL(API); u.searchParams.set('action','masters'); const r=await fetch(u); const j=await r.json(); const m=j.masters||{};
  const keyBy=pred=>Object.keys(m).find(k=>pred(k.toLowerCase()));
  masters.users   =(m[keyBy(k=>k.includes('user'))]||[]).filter(Boolean);
  masters.items   =(m[keyBy(k=>k.includes('item'))]||[]).filter(Boolean);
  masters.colours =(m[keyBy(k=>k.includes('colour')||k.includes('color'))]||[]).filter(Boolean);
  const sizes =(m[keyBy(k=>k.includes('bag')&&k.includes('size'))]||[]);
  const weights=(m[keyBy(k=>k.includes('bag')&&(k.includes('kg')||k.includes('weight')||k.includes('qty')))]||[]);
  masters.bagPairs=sizes.map((s,i)=>({size:s, weight:Number(weights[i]||0)}));
  // populate filters & editor dropdowns
  fillSel('fUser', ['All', ...masters.users]);
  fillSel('eUser', masters.users);
  fillSel('eItem', masters.items);
  fillSel('eColour', masters.colours);
  fillSelPairs('eBag', masters.bagPairs);
}
async function loadRecords(){
  byId('loader').classList.remove('hidden');
  const u=new URL(API); u.searchParams.set('action','list'); const r=await fetch(u); const j=await r.json();
  records=j.records||[]; filtered=records; render(); byId('loader').classList.add('hidden');
}

/* ===== UI HELPERS ===== */
function fillSel(id, arr){ const el=byId(id); el.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); }); }
function fillSelPairs(id, arr){ const el=byId(id); el.innerHTML=''; arr.forEach(p=>{ const o=document.createElement('option'); o.value=p.size; o.textContent=p.size; o.dataset.weight=p.weight; el.appendChild(o); }); }

/* ===== FILTERING ===== */
function applyFilters(){
  const H=headerMap;
  const user = byId('fUser').value;
  const from = byId('fFrom').value ? new Date(byId('fFrom').value) : null;
  const to   = byId('fTo').value   ? new Date(byId('fTo').value)   : null;
  const q    = (byId('q').value||'').toLowerCase();

  filtered = records.filter(r=>{
    if (user && user!=='All' && H.USER && String(r[H.USER])!==user) return false;
    if (from || to){
      const k=H.TIMESTAMP; if(!k) return false;
      const d = r[k]? new Date(r[k]) : null; if(!d || isNaN(d)) return false;
      if (from && d<from) return false;
      if (to && d>to) return false;
    }
    if (q){
      const hay = [H.ITEM? r[H.ITEM]:'', H.COLOUR? r[H.COLOUR]:'', H.LOT? r[H.LOT]:'' ].map(x=>String(x||'').toLowerCase()).join(' ');
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  render();
}

byId('fUser').addEventListener('change', applyFilters);
byId('fFrom').addEventListener('change', applyFilters);
byId('fTo').addEventListener('change', applyFilters);
byId('q').addEventListener('input', debounce(applyFilters, 200));
byId('btnClear').addEventListener('click', ()=>{
  byId('fUser').value='All'; byId('fFrom').value=''; byId('fTo').value=''; byId('q').value='';
  applyFilters();
});
byId('btnRefresh').addEventListener('click', ()=> loadRecords());

/* ===== RENDER ===== */
function render(){
  const el=byId('records'); el.innerHTML='';
  const H=headerMap;
  filtered.forEach(r=>{
    const id=r._id, item=H.ITEM?r[H.ITEM]:'', colour=H.COLOUR?r[H.COLOUR]:'', qty=H.QTY?r[H.QTY]:'', lot=H.LOT?r[H.LOT]:'', ts=H.TIMESTAMP?r[H.TIMESTAMP]:'';
    const card=document.createElement('div');
    card.className='glass dark rounded-2xl p-3 flex items-center justify-between gap-3';
    card.innerHTML=`
      <div>
        <div class="font-semibold">${item||'-'} <span class="opacity-60">${colour||''}</span></div>
        <div class="text-xs opacity-70">User: ${H.USER?r[H.USER]:''} ‚Ä¢ Lot: ${lot||'-'} ‚Ä¢ Qty: ${qty||'-'} ${ts? '‚Ä¢ '+fmtDate(ts): ''}</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded-xl glass dark text-sm" data-id="${id}" data-act="edit">Edit</button>
        <button class="px-3 py-2 rounded-xl bg-rose-500 hover:bg-rose-400 text-white text-sm" data-id="${id}" data-act="del">Delete</button>
      </div>`;
    el.appendChild(card);
  });
}

/* ===== EDITOR ===== */
document.getElementById('records').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=Number(btn.dataset.id), act=btn.dataset.act;
  if(act==='del'){ if(!confirm('Delete this row?')) return; const u=new URL(API); u.searchParams.set('action','delete'); u.searchParams.set('id',id); await (await fetch(u)).json(); toast('Deleted'); await loadRecords(); return; }
  if(act==='edit'){ openEditor(id); }
});
function openEditor(id){
  const r=records.find(x=>x._id===id); if(!r) return;
  const H=headerMap; editing.id=id; editing.record={...r};

  // Fill dropdowns first (already loaded in masters)
  // Set values
  byId('eUser').value = H.USER? (r[H.USER]||'') : '';
  setSelectValue('eItem', H.ITEM? r[H.ITEM] : '');
  setSelectValue('eColour', H.COLOUR? r[H.COLOUR] : '');
  setSelectValue('eBag', H.BAGSIZE? r[H.BAGSIZE] : '');

  byId('eLot').value  = H.LOT? (r[H.LOT]||'') : '';
  byId('eQty').value  = H.QTY? (r[H.QTY]||'') : '';
  // Auto-calc bag kg on open
  autoEditBagKg();
  byId('editSheet').classList.add('open');
}
function setSelectValue(id, val){
  const el=byId(id);
  const opt = Array.from(el.options).find(o=> String(o.value)===String(val));
  if(opt) el.value=opt.value;
}

function autoEditBagKg(){
  const sel=byId('eBag'); const w=Number((sel.selectedOptions[0]?.dataset.weight)||0);
  const qty=Number(byId('eQty').value||0);
  byId('eBagKg').value = ((qty*w)/1000).toFixed(2);
}
byId('eQty').addEventListener('input', autoEditBagKg);
byId('eBag').addEventListener('change', autoEditBagKg);

/* Searchable selects in editor */
byId('eItemSearch').addEventListener('input', e=> filterSel('eItem', masters.items, e.target.value));
byId('eColourSearch').addEventListener('input', e=> filterSel('eColour', masters.colours, e.target.value));
function filterSel(selectId, src, q){ const el=byId(selectId); const list=src.filter(x=>String(x).toLowerCase().includes((q||'').toLowerCase())); el.innerHTML=''; list.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); }); }

byId('btnSaveEdit').addEventListener('click', async ()=>{
  if(!editing.id) return;
  const H=headerMap; const rec={...editing.record};
  if(H.USER)    rec[H.USER]    = byId('eUser').value;
  if(H.LOT)     rec[H.LOT]     = byId('eLot').value;
  if(H.ITEM)    rec[H.ITEM]    = byId('eItem').value;
  if(H.COLOUR)  rec[H.COLOUR]  = byId('eColour').value;
  if(H.QTY)     rec[H.QTY]     = Number(byId('eQty').value||0);
  if(H.BAGSIZE) rec[H.BAGSIZE] = byId('eBag').value;
  if(H.BAGKG)   rec[H.BAGKG]   = Number(byId('eBagKg').value||0);

  const res = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'update', id: editing.id, record: rec }) });
  await res.json();
  toast('Saved'); byId('editSheet').classList.remove('open'); await loadRecords();
});

byId('btnCloseSheet').addEventListener('click', ()=> byId('editSheet').classList.remove('open'));

/* ===== INIT ===== */
(async function init(){
  await loadMeta();
  await loadMasters();
  await loadRecords();
})();
</script>
</body>
</html>
